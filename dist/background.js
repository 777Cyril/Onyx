var u=Object.defineProperty;var f=(n,e,i)=>e in n?u(n,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):n[e]=i;var p=(n,e,i)=>f(n,typeof e!="symbol"?e+"":e,i);const c=class c{constructor(){p(this,"snippetCache",[]);p(this,"cacheReady",!1);p(this,"cachePromise",null)}static getInstance(){return c.instance||(c.instance=new c),c.instance}async initializeCache(){return this.cachePromise?this.cachePromise:(this.cachePromise=new Promise((e,i)=>{chrome.storage.sync.get(null,r=>{try{const s=r["onyx-index"]||[],a=[];for(const o of s){const t=`snippet-${o}`,d=r[t];d&&a.push(d)}a.sort((o,t)=>(t.createdAt||0)-(o.createdAt||0)),this.snippetCache=a,this.cacheReady=!0,console.log("Snippet cache initialized with",a.length,"snippets"),e()}catch(s){console.error("Error loading snippets:",s),this.cacheReady=!0,i(s)}})}),this.cachePromise)}async getSnippets(){return this.cacheReady||await this.initializeCache(),[...this.snippetCache]}getSnippetsSync(){return this.cacheReady?[...this.snippetCache]:(console.warn("Snippet cache not ready, returning empty array"),[])}isCacheReady(){return this.cacheReady}filterSnippets(e){const i=this.getSnippetsSync();if(!e)return i;const r=e.toLowerCase();return i.filter(s=>(s.title||"").toLowerCase().includes(r)).sort((s,a)=>{const o=(s.title||"").toLowerCase().indexOf(r),t=(a.title||"").toLowerCase().indexOf(r);return o-t})}findExactMatch(e){return e.trim()&&this.getSnippetsSync().find(s=>s.title.toLowerCase()===e.toLowerCase().trim())||null}findSnippetMatch(e){if(!e)return null;const i=this.getSnippetsSync(),r=e.toLowerCase().trim(),s=i.find(t=>t.title.toLowerCase()===r);if(s)return s;const a=i.find(t=>t.title.toLowerCase().startsWith(r));return a||i.find(t=>t.title.toLowerCase().includes(r))||null}invalidateCache(){this.cacheReady=!1,this.cachePromise=null,this.snippetCache=[],console.log("Snippet cache invalidated")}async refreshCache(){this.invalidateCache(),await this.initializeCache()}};p(c,"instance");let l=c;const h=l.getInstance();typeof chrome<"u"&&chrome.storage&&chrome.storage.onChanged.addListener((n,e)=>{e==="sync"&&(console.log("Storage changed, invalidating cache"),h.invalidateCache())});console.log("Onyx background script initialized");function g(n){try{if(n.startsWith("{")){const e=JSON.parse(n);return{message:e.message||e.prompt||e.text||e.content,parsedBody:e}}else if(n.includes("&")){const e=new URLSearchParams(n);return{message:e.get("message")||e.get("prompt")||e.get("text")||void 0}}}catch(e){console.error("Error parsing request body:",e)}return{}}function m(n){if(!h.isCacheReady())return console.log("Snippet cache not ready, skipping modification"),n;const{message:e,parsedBody:i}=g(n);if(!e)return n;const r=e.match(/x\/([^\/\s]*)$/);if(!r)return n;const s=r[1]||"";console.log("Detected snippet pattern in request:",s);const a=h.findSnippetMatch(s);if(!a)return console.log("No matching snippet found for:",s),n;console.log("Found matching snippet:",a.title);const o=e.replace(/x\/[^\/\s]*$/,a.content);if(i){const t={...i};return t.message?t.message=o:t.prompt?t.prompt=o:t.text?t.text=o:t.content&&(t.content=o),JSON.stringify(t)}else{const t=new URLSearchParams(n);return t.has("message")?t.set("message",o):t.has("prompt")?t.set("prompt",o):t.has("text")&&t.set("text",o),t.toString()}}chrome.webRequest.onBeforeRequest.addListener(n=>{if(n.method!=="POST"||!n.requestBody)return{};console.log("Intercepting Claude.ai request:",n.url);try{let e="";if(n.requestBody.formData){const r=n.requestBody.formData,s=new URLSearchParams;for(const[a,o]of Object.entries(r))Array.isArray(o)&&s.set(a,o[0]);e=s.toString()}else if(n.requestBody.raw){const r=new TextDecoder;for(const s of n.requestBody.raw)e+=r.decode(s.bytes)}if(!e)return{};const i=m(e);return i===e?{}:(console.log("Modified request body for snippet injection"),console.log("Would modify body to:",i.substring(0,100)+"..."),{})}catch(e){return console.error("Error intercepting request:",e),{}}},{urls:["https://claude.ai/api/*","https://claude.ai/chats/*","https://claude.ai/chat/*","https://*.anthropic.com/api/*"]},["blocking","requestBody"]);h.initializeCache();console.log("Claude.ai HTTP request interception enabled");
