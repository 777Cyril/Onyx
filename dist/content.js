let n={active:!1,target:null,startPosition:0,searchQuery:"",selectedIndex:0,filteredSnippets:[]};function E(){let e=document.getElementById("onyx-picker");if(e)return e;e=document.createElement("div"),e.id="onyx-picker",Object.assign(e.style,{position:"absolute",background:"#2a2a2a",border:"1px solid #404040",borderRadius:"8px",padding:"0",fontSize:"14px",boxShadow:"0 8px 24px rgba(0,0,0,0.4)",zIndex:"2147483647",minWidth:"200px",maxWidth:"350px",maxHeight:"280px",overflowY:"auto",overflowX:"hidden"});const t=document.createElement("style");return t.textContent=`
        #onyx-picker::-webkit-scrollbar {
            width: 8px;
        }
        #onyx-picker::-webkit-scrollbar-track {
            background: #2a2a2a;
        }
        #onyx-picker::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
        }
        #onyx-picker::-webkit-scrollbar-thumb:hover {
            background: #666;
        }
    `,document.head.appendChild(t),document.body.appendChild(e),e}function x(){const e=document.getElementById("onyx-picker");e&&e.remove(),n.target,n={active:!1,target:null,startPosition:0,searchQuery:"",selectedIndex:0,filteredSnippets:[]},document.removeEventListener("click",k)}function k(e){const t=document.getElementById("onyx-picker"),i=e.target;t&&!t.contains(i)&&i!==n.target&&x()}function I(e,t){if(!t)return e;const i=t.toLowerCase();return e.filter(r=>(r.title||"").toLowerCase().includes(i)).sort((r,o)=>{const c=(r.title||"").toLowerCase().indexOf(i),a=(o.title||"").toLowerCase().indexOf(i);return c-a})}function S(e,t){if(!t)return e;const i=new RegExp(`(${t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})`,"gi");return e.replace(i,'<span style="color: #ff0000; font-weight: 500;">$1</span>')}function b(e,t){const i=t.getBoundingClientRect(),r=e.offsetHeight,c=window.innerHeight-i.bottom,a=i.top;let s=i.bottom+window.scrollY+8,l=i.left+window.scrollX;c<r&&a>c&&(s=i.top+window.scrollY-r-8);const p=e.offsetWidth,d=window.innerWidth;if(l+p>d-20&&(l=d-p-20),t.isContentEditable&&n.startPosition>0){const u=window.getSelection();if(u&&u.rangeCount>0){const f=u.getRangeAt(0).getClientRects();if(f.length>0){const g=f[0];l=g.left+window.scrollX,s=g.bottom+window.scrollY+8,l+p>d-20&&(l=d-p-20)}}}e.style.top=`${s}px`,e.style.left=`${l}px`}function w(e){const t=E();if(t.innerHTML="",e.length===0){const i=document.createElement("div");i.textContent="No matching prompts",Object.assign(i.style,{padding:"12px 16px",color:"#999",fontStyle:"italic",textAlign:"center"}),t.appendChild(i),b(t,n.target);return}e.forEach((i,r)=>{const o=document.createElement("div");o.setAttribute("data-snippet-index",r.toString());const c=S(i.title||`Snippet ${r+1}`,n.searchQuery);o.innerHTML=`<div>${c}</div>`,Object.assign(o.style,{padding:"10px 16px",cursor:"pointer",backgroundColor:r===n.selectedIndex?"#404040":"transparent",color:"#e5e5e5",borderBottom:r<e.length-1?"1px solid #333":"none",transition:"background-color 0.15s ease",borderRadius:r===0?"8px 8px 0 0":r===e.length-1?"0 0 8px 8px":"0"}),o.addEventListener("mouseenter",()=>{o.style.backgroundColor="#404040",n.selectedIndex=r,v()}),o.addEventListener("mouseleave",()=>{r!==n.selectedIndex&&(o.style.backgroundColor="transparent")}),o.addEventListener("mousedown",a=>{a.preventDefault(),m(i)}),t.appendChild(o)}),b(t,n.target)}function v(){const e=document.getElementById("onyx-picker");if(!e)return;e.querySelectorAll("[data-snippet-index]").forEach((i,r)=>{const o=i;o.style.backgroundColor=r===n.selectedIndex?"#404040":"transparent"})}function y(e){const t=document.getElementById("onyx-picker");if(!t)return;n.selectedIndex=Math.max(0,Math.min(e,n.filteredSnippets.length-1)),v();const r=t.querySelectorAll("[data-snippet-index]")[n.selectedIndex];r&&r.scrollIntoView({block:"nearest"})}function m(e){if(!n.target)return;const t=n.target,i=n.startPosition,r=e.content||"";console.log("🎯 Inserting snippet:",e.title);try{if(t.tagName==="INPUT"||t.tagName==="TEXTAREA"){const o=t,c=o.value,a=o.selectionStart||0,s=c.slice(0,i),l=c.slice(a),p=s+r+l;o.value=p;const d=s.length+r.length;o.setSelectionRange(d,d),o.dispatchEvent(new Event("input",{bubbles:!0})),o.dispatchEvent(new Event("change",{bubbles:!0}))}else if(t.isContentEditable){const o=window.getSelection();if(!o||!o.focusNode)return;const c=o.focusNode,a=c.textContent||"",s=o.focusOffset,l=a.slice(0,i),p=a.slice(s);c.textContent=l+r+p;const d=l.length+r.length;o.collapse(c,d),t.dispatchEvent(new InputEvent("input",{bubbles:!0,cancelable:!0,inputType:"insertText",data:r}))}console.log("✅ Snippet inserted successfully")}catch(o){console.error("❌ Error inserting snippet:",o)}x()}function C(e){if(n.active)switch(e.key){case"ArrowDown":e.preventDefault(),e.stopPropagation(),y(n.selectedIndex+1);break;case"ArrowUp":e.preventDefault(),e.stopPropagation(),y(n.selectedIndex-1);break;case"Enter":if(n.filteredSnippets.length>0){e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation();const t=n.filteredSnippets[n.selectedIndex];return t&&m(t),!1}break;case"Tab":if(n.filteredSnippets.length>0){e.preventDefault(),e.stopPropagation();const t=n.filteredSnippets[n.selectedIndex];t&&m(t)}break;case"Escape":e.preventDefault(),x();break}}document.addEventListener("input",async e=>{const t=e.target;if(!(t.tagName==="INPUT"||t.tagName==="TEXTAREA"||t.isContentEditable))return;let r="",o=0;if(t.tagName==="INPUT"||t.tagName==="TEXTAREA"){const s=t;r=s.value,o=s.selectionStart||0}else{const s=window.getSelection();if(!s||!s.focusNode||s.focusNode.nodeType!==Node.TEXT_NODE)return;r=s.focusNode.textContent||"",o=s.focusOffset}const a=r.slice(0,o).match(/x\/([^\/\s]*)$/);if(a){const s=a[1]||"",l=a.index||0;console.log("🔍 Snippet mode active, query:",s),n.active=!0,n.target=t,n.startPosition=l,n.searchQuery=s,n.selectedIndex=0,chrome.storage.sync.get(null,async p=>{try{const d=p["onyx-index"]||[],u=[];for(const h of d){const f=`snippet-${h}`,g=p[f];g&&u.push(g)}u.sort((h,f)=>(f.createdAt||0)-(h.createdAt||0)),n.filteredSnippets=I(u,s),w(n.filteredSnippets),document.getElementById("onyx-picker")||setTimeout(()=>{document.addEventListener("click",k)},0)}catch(d){console.error("Error loading snippets in content script:",d),n.filteredSnippets=[],w([])}})}else n.active&&x()});document.addEventListener("keydown",e=>{C(e)},!0);document.addEventListener("keydown",e=>{if(e.key==="Enter"&&n.active&&n.filteredSnippets.length>0)return e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),!1},!0);window.addEventListener("beforeunload",()=>{x()});
