let n={active:!1,target:null,startPosition:0,searchQuery:"",selectedIndex:0,filteredSnippets:[]};function k(){let e=document.getElementById("onyx-picker");if(e)return e;e=document.createElement("div"),e.id="onyx-picker",Object.assign(e.style,{position:"absolute",background:"#2a2a2a",border:"1px solid #404040",borderRadius:"8px",padding:"0",fontSize:"14px",boxShadow:"0 8px 24px rgba(0,0,0,0.4)",zIndex:"2147483647",minWidth:"200px",maxWidth:"350px",maxHeight:"280px",overflowY:"auto",overflowX:"hidden"});const t=document.createElement("style");return t.textContent=`
        #onyx-picker::-webkit-scrollbar {
            width: 8px;
        }
        #onyx-picker::-webkit-scrollbar-track {
            background: #2a2a2a;
        }
        #onyx-picker::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
        }
        #onyx-picker::-webkit-scrollbar-thumb:hover {
            background: #666;
        }
    `,document.head.appendChild(t),document.body.appendChild(e),e}function u(){const e=document.getElementById("onyx-picker");e&&e.remove(),n.target,n={active:!1,target:null,startPosition:0,searchQuery:"",selectedIndex:0,filteredSnippets:[]},document.removeEventListener("click",w)}function w(e){const t=document.getElementById("onyx-picker"),r=e.target;t&&!t.contains(r)&&r!==n.target&&u()}function v(e,t){if(!t)return e;const r=t.toLowerCase();return e.filter(i=>(i.title||"").toLowerCase().includes(r)).sort((i,o)=>{const c=(i.title||"").toLowerCase().indexOf(r),a=(o.title||"").toLowerCase().indexOf(r);return c-a})}function E(e,t){if(!t)return e;const r=new RegExp(`(${t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})`,"gi");return e.replace(r,'<span style="color: #ff0000; font-weight: 500;">$1</span>')}function m(e,t){const r=t.getBoundingClientRect(),i=e.offsetHeight,c=window.innerHeight-r.bottom,a=r.top;let s=r.bottom+window.scrollY+8,l=r.left+window.scrollX;c<i&&a>c&&(s=r.top+window.scrollY-i-8);const p=e.offsetWidth,d=window.innerWidth;if(l+p>d-20&&(l=d-p-20),t.isContentEditable&&n.startPosition>0){const f=window.getSelection();if(f&&f.rangeCount>0){const x=f.getRangeAt(0).getClientRects();if(x.length>0){const h=x[0];l=h.left+window.scrollX,s=h.bottom+window.scrollY+8,l+p>d-20&&(l=d-p-20)}}}e.style.top=`${s}px`,e.style.left=`${l}px`}function S(e){const t=k();if(t.innerHTML="",e.length===0){const r=document.createElement("div");r.textContent="No matching prompts",Object.assign(r.style,{padding:"12px 16px",color:"#999",fontStyle:"italic",textAlign:"center"}),t.appendChild(r),m(t,n.target);return}e.forEach((r,i)=>{const o=document.createElement("div");o.setAttribute("data-snippet-index",i.toString());const c=E(r.title||`Snippet ${i+1}`,n.searchQuery);o.innerHTML=`<div>${c}</div>`,Object.assign(o.style,{padding:"10px 16px",cursor:"pointer",backgroundColor:i===n.selectedIndex?"#404040":"transparent",color:"#e5e5e5",borderBottom:i<e.length-1?"1px solid #333":"none",transition:"background-color 0.15s ease",borderRadius:i===0?"8px 8px 0 0":i===e.length-1?"0 0 8px 8px":"0"}),o.addEventListener("mouseenter",()=>{o.style.backgroundColor="#404040",n.selectedIndex=i,y()}),o.addEventListener("mouseleave",()=>{i!==n.selectedIndex&&(o.style.backgroundColor="transparent")}),o.addEventListener("mousedown",a=>{a.preventDefault(),g(r)}),t.appendChild(o)}),m(t,n.target)}function y(){const e=document.getElementById("onyx-picker");if(!e)return;e.querySelectorAll("[data-snippet-index]").forEach((r,i)=>{const o=r;o.style.backgroundColor=i===n.selectedIndex?"#404040":"transparent"})}function b(e){const t=document.getElementById("onyx-picker");if(!t)return;n.selectedIndex=Math.max(0,Math.min(e,n.filteredSnippets.length-1)),y();const i=t.querySelectorAll("[data-snippet-index]")[n.selectedIndex];i&&i.scrollIntoView({block:"nearest"})}function g(e){if(!n.target)return;const t=n.target,r=n.startPosition,i=e.content||"";console.log("🎯 Inserting snippet:",e.title);try{if(t.tagName==="INPUT"||t.tagName==="TEXTAREA"){const o=t,c=o.value,a=o.selectionStart||0,s=c.slice(0,r),l=c.slice(a),p=s+i+l;o.value=p;const d=s.length+i.length;o.setSelectionRange(d,d),o.dispatchEvent(new Event("input",{bubbles:!0})),o.dispatchEvent(new Event("change",{bubbles:!0}))}else if(t.isContentEditable){const o=window.getSelection();if(!o||!o.focusNode)return;const c=o.focusNode,a=c.textContent||"",s=o.focusOffset,l=a.slice(0,r),p=a.slice(s);c.textContent=l+i+p;const d=l.length+i.length;o.collapse(c,d),t.dispatchEvent(new InputEvent("input",{bubbles:!0,cancelable:!0,inputType:"insertText",data:i}))}console.log("✅ Snippet inserted successfully")}catch(o){console.error("❌ Error inserting snippet:",o)}u()}function I(e){if(n.active)switch(e.key){case"ArrowDown":e.preventDefault(),e.stopPropagation(),b(n.selectedIndex+1);break;case"ArrowUp":e.preventDefault(),e.stopPropagation(),b(n.selectedIndex-1);break;case"Enter":if(n.filteredSnippets.length>0){e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation();const t=n.filteredSnippets[n.selectedIndex];return t&&g(t),!1}break;case"Tab":if(n.filteredSnippets.length>0){e.preventDefault(),e.stopPropagation();const t=n.filteredSnippets[n.selectedIndex];t&&g(t)}break;case"Escape":e.preventDefault(),u();break}}document.addEventListener("input",async e=>{const t=e.target;if(!(t.tagName==="INPUT"||t.tagName==="TEXTAREA"||t.isContentEditable))return;let i="",o=0;if(t.tagName==="INPUT"||t.tagName==="TEXTAREA"){const s=t;i=s.value,o=s.selectionStart||0}else{const s=window.getSelection();if(!s||!s.focusNode||s.focusNode.nodeType!==Node.TEXT_NODE)return;i=s.focusNode.textContent||"",o=s.focusOffset}const a=i.slice(0,o).match(/x\/([^\/\s]*)$/);if(a){const s=a[1]||"",l=a.index||0;console.log("🔍 Snippet mode active, query:",s),n.active=!0,n.target=t,n.startPosition=l,n.searchQuery=s,n.selectedIndex=0,chrome.storage.sync.get(null,p=>{const d=p["onyx-snippets"]||[];n.filteredSnippets=v(d,s),S(n.filteredSnippets),document.getElementById("onyx-picker")||setTimeout(()=>{document.addEventListener("click",w)},0)})}else n.active&&u()});document.addEventListener("keydown",e=>{I(e)},!0);document.addEventListener("keydown",e=>{if(e.key==="Enter"&&n.active&&n.filteredSnippets.length>0)return e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),!1},!0);window.addEventListener("beforeunload",()=>{u()});
